# Chapter01

## 단일서버
<img src="https://github.com/user-attachments/assets/fae8b881-44fe-4c12-b0f1-161d76767813" width="400" height="300"/> <br>
- 단일 서버란 웹, 앱, DB, 캐시 등 하나의 서버에서 실행되는 것을 말한다.
- 사용자가 증가하면 수평적 규모 확장을 통해 서버를 분리하는 것이 좋다.

<img src="https://github.com/user-attachments/assets/db738d97-f7f2-4c40-8bc2-6eeec2348eb6" width="400" height="300"/> <br>

- 위 사진은 프레젠테이션에서 발생하는 트래픽 처리 서버와 데이터베이스 서버를 수평적 규모 확장을 통해 분리한 모습이다.

## 수직적 규모 확장과 수평적 규모 확장

- 수직적 규모 확장(Scale up)은 서버에 고사양 자원(CPU, RAM)을 추가하는 행위이다.
- 수평적 규모 확장(Scale out)은 더 많은 서버를 추가하여 성능을 개선하는 행위이다.
- 수직적 규모 확장의 단점
    - 하나의 서버에 CPU, Memory를 무한대로 증설할 수 없다.
    - 하나의 서버에 장애가 발생하였을 대 자동복구 방안 혹은 다중화 방안을 제시할 수 없다.
- 대부분의 대규모 애플리케이션을 지원하는 방법은 수평적 규모 확장이다.

## 관계형 데이터베이스과 비-관계형 데이터베이스

### 관계형 데이터베이스

- RDBMS로 데이터를 Table, Row, Column으로 표현한다.
- SQL을 사용하면 테이블의 관계에 따라 데이터를 조인하여 합칠 수 있다.

### 비-관계형 데이터베이스

- 비-관계형 데이터베이스의 종류는 키-값 저장소, 그래프 저장소, 칼럼 저장소, 문서 저장소로 나뉜다.
- 관계형 데이터베이스와 다르게 조인 연산은 지원하지 않는다.

### 관계형 데이터베이스가 아닌 비-관계형 데이터 베이스를 사용할 때의 환경

- 아주 낮은 응답 지연시간
- 데이터가 비정형일 때
- 데이터를 단순히 직렬화하거나 역직렬화 할 때
- 많은 양의 데이터를 저장할 필요가 있을 때

## 데이터베이스 다중화
<img src="https://github.com/user-attachments/assets/cbf48f84-42bd-4c9f-b8dc-3266e47e5d48" width="400" height="300"/> <br>


- 데이터베이스를 다중화 하였을 때 데이터베이스 서버 사이의 Master-Slave 관계가 설정된다.
- 데이터의 원본은 Master인 주 서버에, 사본은 Slave인 부 서버에 저장된다.
- Master에 지원되는 기능은 쓰기 연산이 지원되고 Slave에는 읽기 연산만을 지원한다.
- 대부분의 애플리케이션의 기능은 쓰기 연산보다 읽기 연산을 많이 사용하기 때문에 Slave 데이터베이스의 서버가 많다.

### 데이터베이스 다중화의 장점

- Perfomance Efficiency : 모든 데이터 변경 연산은 Master에 읽기 연산은 Slave에서 처리함으로, 병렬로 처리될 수 있는 query의 수가 늘어난다.
- Reliability : 외부 환경 요인에 의해 일부의 서버가 다운되어도 데이터는 보존된다.
- Availability : 데이터를 여러 서버에 복제해 둠으로써, 하나의 데이터 베이스 서버에 장애가 발생하더라도 다른 서버에 있는 데이터를 가져와 계속 서비스를 할 수 있다.

## 캐시
<img src="https://github.com/user-attachments/assets/a9cbf91f-4db0-4d04-9e32-1c48cfb14e2e" width="400" height="300"/> <br>


- 캐시 계층을 사용하면 성능 개선 및 데이터베이스의 부하 감소, 독립적으로 확장이 가능하다.
- 캐시를 사용한다면 아래 5가지 질문에 대해 답변해보자.
    - 캐시는 어떤 상황에 바람직한가?
    - 어떤 데이터를 캐시에 두어야한가?
    - 캐시에 보관된 데이터는 어떻게 만료가 되는가?
    - 일관성은 어떻게 유지하는가?
    - 장애에 어떻게 대처할것인가?
- 캐시를 사용할 때 주의할 점
    - 캐시 메모리를 작게 잡지 말 것, 엑세스 패턴에 따라 데이터가 캐시에서 밀려나서 캐시의 성능 저하
    - 데이터 방출 정책 수립
        - LRU : 마지막으로 사용된 시점이 가장 오래된 데이터를 내보내는 정책
        - LFU : 사용된 빈도가 가장 낮은 데이터를 내보내는 정책
        - FIFO : 가장 먼저 캐시에 들어온 데이터를 가장 먼저 내보내는 정책

## 무상태(Stateless) 웹 계층
<img src="https://github.com/user-attachments/assets/2b487140-41a7-493b-81dc-f06b97548835" width="400" height="300"/> <br>


- Http 같은 언어는 무상태성을 가지고 있기 때문에, 상태를 기억하기 위해 쿠키나 세션같은 값을 저장해야 한다. 이를 공유 저장소인 DB or Memcached/Redis 같은 곳에 저장할 수 있다.

## 메시지 큐
<img src="https://github.com/user-attachments/assets/8c478dda-5ec5-4aa2-ba8a-bef3c214ea79" width="400" height="300"/> <br>


- 메시지 큐는 메시지의 무손실을 보장과 비동기 통신을 지원하는 컴포넌트다.
- 메시지 큐를 사용하는 이유는 서비스 또는 서버 간 결합이 느슨해지기 때문에, MSA와 같은 규모 확정성이 보장되어야 하는 애플리케이션에 구성하기 좋다.

## 데이터베이스의 규모 확장

- 데이터베이스도 Scale Up, Scale Out을 할 수 있다.
- 하지만 단순히 Scale Up을 통해 데이터베이스를 확장한다면 SPOF(Single Point Of Failure), 고비용, 트래픽 과부화 등 많은 문제점이 발생한다. 이로 인해 Scale Out을 통해 확장한다.
- Scale Out의 대표적인 확장은 sharding이다. 샤딩은 대규모 데이터베이스를 샤드라고 부르는 작은 단위로서 분리하는 기술을 말한다.
- 샤딩을 도입하면 시스템이 복잡해지고 다음과 같은 문제점이 발생한다.
    - 데이터의 재 샤딩
        - 데이터가 너무 많아져서 하나의 샤드로는 감당하기 어려울 때
        - 샤드 간 데이터 분포가 균등하지 못해 샤드 소진이 발생했을 때
        - 이를 해결하기 위해 샤드 키를 계산하는 함수를 변경하고 데이터를 재 배치해야 한다.
    - 유명인사
        - 핫스팟 키와 같은 말로 특정 샤드에 Query가 집중되어 서버에 과부하가 걸렸을 때
        - 이를 해결하기 위해 특정 샤드의 값들을 각각의 샤드로 재 배치, 혹은 더 세분화해야 한다.
    - 조인과 비정규화
        - 하나의 데이터베이스를 여러 샤드 서버로 쪼개면, 데이터를 조인하기가 어려워진다.
        - 이를 해결하기 위해 비-관계형 데이터베이스로 전환하여 하나의 테이블에서 질의가 수행될 수 있게 한다.

## 정리
<img src="https://github.com/user-attachments/assets/c6b26245-7952-49f3-b528-a1796a49d84b" width="400" height="300"/> <br>

- 웹 계층은 무상태 계층으로 만들 것
- 모든 계층에 다중화 도입할 것
- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
- 각 계층은 독립적 서비스로 분할할 것
